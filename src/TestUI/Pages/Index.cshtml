@page
@model IndexModel
@{
    ViewData["Title"] = "Test Home page";
}

@*Darren Sibson - 16 Nov 2022*@
  
<div class="text-center">
    <div class="row pb-3">
        <div class="col-3"><label>Search:</label>&nbsp;<input type="text" id="searchFilter" /></div>
        <div class="col-1"><input type="button" id="search" value="Search" /></div>
    </div>
    <div class="row pb-3">

    </div>
    <div class="form-group">
        <div class="row pb-3">
            <input type="text" id="addFirstName" class="col-2" />
            <input type="text" id="addLastName" class="col-2" />
            <input type="button" id="add" value="Add" class="col-1" />
        </div>
    </div>

    <div class="form-group">
        <div class="row pb-3">
            <select id="updateSelectCustomer" class="col-2"></select>
            <label class="col-2 control-label text-right">Change: FirstName: </label>
            <input type="text" id="updateFirstName" class="col-2" />
            <label class="col-2">Last Name: </label>
            <input type="text" id="updateLastName" class="col-2" />
            <input type="button" id="update" value="Update" class="col-2" />
        </div>
    </div>
</div>
<div>
    <div id="status" class="text-info"></div>
</div>
<div>
    <div id="results"></div>
</div>

<script>
    $(document).ready(function () {
        setCustomerList();
    });

    $('#getAll').click(function () {
        $.ajax({
            url: "https://localhost:1052/customer",
            type: "GET",
            crossDomain: true,
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var parsed_data = JSON.parse(JSON.stringify(data));
                var searchResults = listResults(parsed_data);
                $('#status').html("Get All Results:");
                $('#results').html(searchResults);
            },
            error: function (data) {
                $('#status').html("An Error Occurred:");
                console.log('Error Getting All Customers');
                console.log(data);
            }
        });
    });

    $('#search').click(function () {
        $.ajax({
            url: "https://localhost:1052/customer/search?searchFilter=" + $("#searchFilter").val(),
            type: "GET",
            crossDomain: true,
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var parsed_data = JSON.parse(JSON.stringify(data));
                var searchResults = listResults(parsed_data);
                $('#status').html("Search Results:");
                $("#results").html(searchResults);
            },
            error: function (data) {
                $('#status').html("An Error Occurred:");
                console.log('Error when Searching');
                console.log(data);
            }
        });
    });

    $('#add').click(function () {
        $.ajax({
            url: "https://localhost:1052/customer/add",
            type: "put",
            crossDomain: true,
            dataType: "json",
            data: JSON.stringify({ "firstName": $("#addFirstName").val(), "lastName": $("#addLastName").val() }),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                $('#status').html("Customer Added");
            },
            error: function (data) {
                $('#status').html("An Error Occurred:");
                console.log('Error Adding Customer');
                console.log(data)
            }
        });
    });

    $('#update').click(function () {
        var selectedId = $('#updateSelectCustomer').find(":selected").val();
        var updateJson = JSON.stringify({ "ID": selectedId, "firstName": $("#updateFirstName").val(), "lastName": $("#updateLastName").val() });

        $.ajax({
            url: "https://localhost:1052/customer/update",
            type: "put",
            crossDomain: true,
            dataType: "json",
            data: updateJson,
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                $('#status').html("Customer " + selectedId + "  Updated");
            },
            error: function (data) {
                $('#status').html("An Error Occurred:");
                console.log('Update - Error');
                console.log(data)
            }
        });

        setCustomerList();
        $("#updateSelectCustomer").val(selectedId).change();
    });

    $('#updateSelectCustomer').change(function () {
        var selectedName = $("#updateSelectCustomer :selected").text();
        var names = selectedName.split(" ")
        $("#updateFirstName").val(names[0]);
        $("#updateLastName").val(names[1]);
    });

    function listResults(jsonData) {
        var results = '';

        for (var i = 0, len = jsonData.length; i < len; ++i) {
            var result = "[" + jsonData[i].firstName + " " + jsonData[i].lastName + "]";
            results += result + "<br/>";
        }

        return results;
    }

    function setCustomerList()
    {
        var allCustomers = "";

        $.ajax({
            url: "https://localhost:1052/customer",
            type: "GET",
            crossDomain: true,
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (allCustomersData) {
                var allCustomers = JSON.parse(JSON.stringify(allCustomersData));
                
                $('#updateSelectCustomer').empty();

                for (var i = 0, len = allCustomers.length; i < len; ++i) {
                    $('#updateSelectCustomer').append(
                        $('<option />')
                            .text(allCustomers[i].firstName + " " + allCustomers[i].lastName)
                            .val(allCustomers[i].id)
                    );
                }
            },
            error: function (data) {
                $('#status').html("An Error Occurred:");
                console.log('Get All - Error');
                console.log(data);
            }
        });
    }
</script>